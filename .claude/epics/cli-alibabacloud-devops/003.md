---
name: 实现init-yunxiao.sh环境检测脚本
status: open
created: 2025-09-30T01:34:16Z
updated: 2025-09-30T01:34:16Z
github: https://github.com/kongsiyu/ccpm/issues/3
depends_on: ["001"]
parallel: true
conflicts_with: []
---

# 任务002：实现init-yunxiao.sh环境检测脚本

## Description

创建一个专门的初始化脚本，用于检测和设置阿里云云效集成的运行环境。该脚本将验证MCP服务可用性、project_id配置，并提供配置指导，确保用户能够顺利使用云效相关功能。

## Acceptance Criteria

1. **环境检测**
   - [ ] 检测阿里云云效MCP服务器连接状态
   - [ ] 验证必要的系统依赖（jq、curl等）
   - [ ] 检查配置文件和环境变量的完整性

2. **配置验证和指导**
   - [ ] 检测MCP服务是否可用
   - [ ] 验证project_id配置的有效性
   - [ ] 提供MCP服务器配置指导

3. **自动化设置**
   - [ ] 自动生成或更新配置文件
   - [ ] 设置合适的文件权限和目录结构
   - [ ] 创建必要的缓存和日志目录

4. **诊断和修复**
   - [ ] 提供详细的诊断信息和错误报告
   - [ ] 自动修复常见的配置问题
   - [ ] 提供故障排除指南和建议

## Technical Details

### 脚本结构
```bash
#!/bin/bash
# .claude/scripts/pm/init-yunxiao.sh

main() {
    print_banner
    check_dependencies
    detect_existing_config
    run_configuration_wizard
    validate_final_setup
    create_cache_directories
    print_success_summary
}
```

### 核心功能模块
- `check_dependencies()` - 系统依赖检查
- `detect_existing_config()` - 现有配置检测
- `run_configuration_wizard()` - 交互式配置向导
- `validate_yunxiao_connection()` - 连接验证
- `setup_directory_structure()` - 目录结构创建
- `generate_config_template()` - 配置模板生成

### 配置检测流程
1. 欢迎界面和功能说明
2. 检测现有配置文件（.ccpm-config.yaml）
3. 检测MCP服务器连接状态
4. 验证project_id配置
5. 提供配置指导和帮助文档
6. 创建工作目录和缓存

### 文件操作
- 读取/写入 `.claude/settings.json`
- 创建 `.claude/cache/yunxiao/` 目录
- 生成 `.claude/logs/yunxiao.log` 日志文件
- 设置适当的文件权限（600 for credentials）

## Dependencies

### 前置任务
- **任务001**：需要基础的配置管理和MCP检测功能

### 外部依赖
- jq（JSON处理）
- curl（HTTP请求，如果MCP不可用）
- bash 4.0+（关联数组支持）

### 内部依赖
- `.claude/lib/yunxiao.sh`（来自任务001）
- `.claude/lib/error.sh`
- `.claude/lib/dependencies.sh`

## Effort Estimate

**2天**

- 第1天：实现基础的环境检测和MCP服务检查功能
- 第2天：完善配置验证和错误处理，提供配置指导

## Definition of Done

1. **功能完整性**
   - [ ] 脚本能够检测MCP服务和配置状态
   - [ ] 提供清晰的配置指导文档
   - [ ] 所有错误场景都有恰当的处理和提示

2. **用户体验**
   - [ ] 提供清晰的配置状态反馈
   - [ ] 错误消息具体且包含解决建议
   - [ ] 提供MCP服务器配置文档链接

3. **鲁棒性**
   - [ ] 处理网络连接问题和超时
   - [ ] 验证用户输入的格式和有效性
   - [ ] 支持配置的备份和恢复

4. **集成性**
   - [ ] 与现有的pm命令体系兼容
   - [ ] 配置格式符合项目标准
   - [ ] 日志记录遵循项目约定

5. **文档**
   - [ ] 脚本包含详细的使用说明
   - [ ] 提供常见问题的解决方案
   - [ ] 配置参数有清楚的说明文档

这个脚本将成为用户开始使用云效集成功能的入口点，确保环境配置正确且用户体验良好。
