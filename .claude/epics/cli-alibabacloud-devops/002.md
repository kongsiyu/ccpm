---
name: 创建MCP基础设施和配置检测机制
status: open
created: 2025-09-30T01:34:16Z
updated: 2025-09-30T01:34:16Z
github: https://github.com/kongsiyu/ccpm/issues/2
depends_on: []
parallel: false
conflicts_with: []
---

# 任务001：创建MCP基础设施和配置检测机制

## Description

建立阿里云云效集成的基础设施，专注于MCP服务检测和简化配置管理。用户自行按照官方文档配置Claude Code的MCP服务器，我们只负责检测MCP服务是否正常运行，并提供简单的project_id配置管理。

## Acceptance Criteria

1. **MCP服务检测**
   - [ ] 实现检测云效MCP服务器是否在Claude Code中正确配置并运行
   - [ ] 提供MCP连接状态验证和错误诊断功能
   - [ ] 如果MCP不可用，提供配置指导文档链接

2. **简化配置管理**
   - [ ] 创建简单的.ccpm-config.yaml配置文件支持（仅platform和project_id）
   - [ ] 实现project_id配置验证功能
   - [ ] 提供MCP服务器配置指导文档

3. **错误处理框架**
   - [ ] 建立标准化的错误消息和状态码
   - [ ] 实现日志记录和调试信息输出
   - [ ] 提供用户友好的错误提示和解决建议

## Technical Details

### 配置结构

#### .ccmp-config.yaml（项目配置）
```yaml
platform: yunxiao
project_id: 12345
```

#### Claude Code MCP配置（用户自行配置）
```json
{
  "mcpServers": {
    "yunxiao": {
      "command": "npx",
      "args": ["-y", "alibabacloud-devops-mcp-server"],
      "env": {
        "YUNXIAO_ACCESS_TOKEN": "<用户的令牌>"
      }
    }
  }
}
```

### MCP服务检测库
检测和调用云效MCP服务：

```bash
# 检测MCP服务是否可用
check_yunxiao_mcp_service() {
    # 尝试通过Claude Code的MCP机制调用云效服务
    if mcp_call_yunxiao "health_check"; then
        echo "✅ 云效MCP服务运行正常"
        return 0
    else
        echo "❌ 云效MCP服务不可用"
        echo "请参考配置指南：/path/to/setup-guide.md"
        return 1
    fi
}

# 简化的MCP调用封装
mcp_call_yunxiao() {
    local action="$1"
    local project_id=$(get_project_id)

    # 通过Claude Code已配置的MCP服务调用
    claude_mcp_call "yunxiao" "$action" --project-id="$project_id"
}
```

### 简化配置验证器
验证project_id配置和MCP服务状态：

```bash
validate_yunxiao_config() {
    local config_file=".ccpm-config.yaml"

    # 检查配置文件存在
    if [ ! -f "$config_file" ]; then
        echo "❌ 配置文件不存在: $config_file"
        return 1
    fi

    # 验证平台设置
    local platform=$(grep "platform:" "$config_file" | cut -d' ' -f2)
    if [ "$platform" != "yunxiao" ]; then
        echo "❌ 平台配置错误，应为: platform: yunxiao"
        return 1
    fi

    # 验证project_id
    local project_id=$(grep "project_id:" "$config_file" | cut -d' ' -f2)
    if [ -z "$project_id" ]; then
        echo "❌ 缺少project_id配置"
        return 1
    fi

    # 检测MCP服务
    check_yunxiao_mcp_service
}
```

### 核心函数
- `check_yunxiao_mcp_service()` - MCP服务器可用性检测
- `validate_yunxiao_config()` - 简化配置验证
- `get_project_id()` - 项目ID获取
- `log_yunxiao_error()` - 错误日志记录

### 文件结构
- `.claude/lib/yunxiao.sh` - 云效工具库（类似 github.sh 的统一库）
  - MCP服务检测函数
  - 配置管理函数
  - 错误处理函数
  - 工作项操作封装函数
- `docs/yunxiao-setup-guide.md` - MCP配置指导文档

## Dependencies

### 外部依赖
- 用户按官方文档配置的Claude Code MCP服务器
- jq 工具（YAML/JSON处理）

### 内部依赖
- `.claude/lib/error.sh`（现有错误处理框架）
- `.claude/lib/dependencies.sh`（依赖检查框架）

## Effort Estimate

**1.5天**

- **Size**: S
- **Hours**: 12小时
- **Parallel**: false（基础设施任务，其他任务依赖）

- 第1天：设计简化配置结构，实现基础的配置管理和MCP检测功能
- 第0.5天：完善错误处理机制，编写用户配置指导文档

## Definition of Done

1. **功能完整性**
   - [ ] MCP服务检测功能开发和测试
   - [ ] 简化配置管理系统实现（仅project_id）
   - [ ] 错误处理覆盖所有主要场景

2. **集成性**
   - [ ] 与现有的 `.claude/lib/` 框架无缝集成
   - [ ] 配置格式简单易用
   - [ ] 错误处理遵循项目标准

3. **文档和测试**
   - [ ] 提供详细的MCP配置指导文档
   - [ ] 包含基础测试覆盖主要功能
   - [ ] MCP服务可用性验证和用户指导

4. **可扩展性**
   - [ ] 设计支持未来添加更多云效功能
   - [ ] 配置结构易于扩展新参数
   - [ ] MCP通信层支持多种操作类型

这个任务为整个云效集成奠定基础，重点关注MCP服务检测和简化配置，用户的认证管理由Claude Code的MCP机制处理。

**设计模式**：参考现有的 `.claude/lib/github.sh` (392行)，创建一个统一的 `.claude/lib/yunxiao.sh` 文件，包含所有云效相关的工具函数，而不是拆分成多个小文件。
