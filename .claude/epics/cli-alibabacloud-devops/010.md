---
name: 实现命令路由和平台检测集成
status: open
created: 2025-09-30T01:34:16Z
updated: 2025-09-30T01:34:16Z
github: https://github.com/kongsiyu/ccpm/issues/10
depends_on: [003, 004, 005]
parallel: false
conflicts_with: []
---

# 任务006：实现命令路由和平台检测集成

## Description

实现智能命令路由系统，通过配置文件自动检测目标平台（GitHub/云效），并将PM命令透明地路由到对应的脚本实现。确保用户无需改变现有命令使用习惯，系统自动根据配置选择合适的后端执行引擎。

## Acceptance Criteria

### 核心路由功能
- [ ] 实现平台检测机制，支持GitHub和云效两种模式
- [ ] 创建统一的命令路由入口点
- [ ] 确保所有PM命令支持平台自动切换
- [ ] 提供平台配置验证和诊断功能

### 配置管理
- [ ] 支持`.ccpm-config.yaml`配置文件解析
- [ ] 实现配置项验证和默认值处理
- [ ] 提供配置错误的清晰诊断信息
- [ ] 支持运行时配置状态检查

### 命令覆盖范围
- [ ] `/pm:epic-*` 命令系列完整支持
- [ ] `/pm:issue-*` 命令系列完整支持
- [ ] `/pm:sync` 和 `/pm:status` 命令支持
- [ ] 其他核心PM命令的路由实现

### 用户体验
- [ ] 命令使用方式保持完全一致
- [ ] 平台切换对用户透明无感知
- [ ] 提供平台状态和配置查看命令

## Technical Details

### 平台检测机制

#### 配置文件结构
```yaml
# .ccpm-config.yaml
platform: yunxiao  # github | yunxiao
project_id: 12345   # 云效项目ID（仅云效需要）
```

#### 检测逻辑实现
```bash
# .claude/lib/platform-detection.sh
get_platform_type() {
    local config_file=".ccpm-config.yaml"
    if [[ ! -f "$config_file" ]]; then
        echo "github"  # 默认GitHub平台
        return 0
    fi

    local platform=$(grep "^platform:" "$config_file" | cut -d':' -f2 | xargs)
    case "$platform" in
        "yunxiao"|"github") echo "$platform" ;;
        *) echo "github" ;;  # 无效配置默认GitHub
    esac
}

validate_platform_config() {
    local platform=$(get_platform_type)
    case "$platform" in
        "yunxiao")
            validate_yunxiao_config
            ;;
        "github")
            validate_github_config
            ;;
    esac
}
```

### 命令路由架构

#### 路由入口设计
```bash
# .claude/commands/pm/*.md 修改
# 在每个PM命令的实现部分添加路由逻辑

# 示例：epic-sync.md
platform=$(get_platform_type)
case "$platform" in
    "yunxiao")
        exec "$CLAUDE_DIR/scripts/pm/epic-sync-yunxiao.sh" "$@"
        ;;
    "github")
        exec "$CLAUDE_DIR/scripts/pm/epic-sync.sh" "$@"
        ;;
    *)
        error "不支持的平台类型: $platform"
        exit 1
        ;;
esac
```

#### 脚本映射表
| PM命令 | GitHub脚本 | 云效脚本 |
|--------|------------|----------|
| epic-sync | epic-sync.sh | epic-sync-yunxiao.sh |
| issue-sync | issue-sync/ | issue-sync-yunxiao/ |
| epic-start | epic-start/ | epic-start-yunxiao/ |
| status | status.sh | status-yunxiao.sh |

### 配置验证机制

#### 云效平台验证
```bash
validate_yunxiao_config() {
    local project_id=$(get_project_id)
    if [[ -z "$project_id" ]]; then
        error "云效平台需要配置project_id"
        return 1
    fi

    # 验证MCP连接
    if ! yunxiao_test_connection; then
        error "无法连接到云效MCP服务，请检查MCP服务器配置"
        return 1
    fi
}
```

#### GitHub平台验证
```bash
validate_github_config() {
    if ! command -v gh &> /dev/null; then
        error "GitHub CLI (gh) 未安装"
        return 1
    fi

    if ! gh auth status &> /dev/null; then
        error "GitHub CLI 未认证，请运行 'gh auth login'"
        return 1
    fi
}
```

### 诊断和故障排查

#### 平台状态检查命令
```bash
# /pm:platform-status 命令实现
show_platform_status() {
    local platform=$(get_platform_type)
    echo "当前平台: $platform"

    case "$platform" in
        "yunxiao")
            show_yunxiao_status
            ;;
        "github")
            show_github_status
            ;;
    esac
}
```

## Dependencies

### 直接依赖
- 任务003：yunxiao工作项CRUD操作脚本集
- 任务004：epic-sync-yunxiao完整目录功能
- 任务005：issue-sync-yunxiao工作项同步脚本

### 技术依赖
- `.claude/lib/platform-detection.sh`：平台检测库
- `.claude/lib/yunxiao.sh`：统一的云效工具库
- YAML解析工具（yq或类似工具）

### 配置依赖
- `.ccpm-config.yaml`：平台配置文件
- 云效MCP服务器配置（如使用云效平台）
- GitHub CLI认证（如使用GitHub平台）

## Effort Estimate

**预估工作量：2天**

### 详细分解
- **平台检测机制**：0.5天
  - 配置文件解析逻辑
  - 平台类型识别
  - 验证机制实现

- **命令路由实现**：1天
  - 修改所有PM命令文件
  - 实现路由逻辑
  - 测试各命令路由正确性

- **配置验证和诊断**：0.5天
  - 实现配置验证功能
  - 添加诊断命令
  - 错误提示优化

### 风险评估
- **配置解析复杂性**：+0.3天（YAML解析可能需要额外工具）
- **命令数量多**：+0.2天（需要修改多个命令文件）

## Definition of Done

### 路由功能完整性
- [ ] 所有PM命令支持平台自动检测和路由
- [ ] 配置文件解析和验证机制完善
- [ ] 平台切换用户体验流畅无感知
- [ ] 错误处理和诊断信息完整

### 配置管理
- [ ] `.ccpm-config.yaml`配置项完整定义
- [ ] 配置验证覆盖所有必要检查项
- [ ] 默认配置和降级机制可靠
- [ ] 配置错误提供清晰的解决指导

### 用户体验
- [ ] 现有命令使用方式无任何变化
- [ ] 平台状态查看命令功能完整
- [ ] 配置错误时有明确的修复建议
- [ ] 切换平台后功能完全对等

### 技术质量
- [ ] 代码结构清晰，易于维护
- [ ] 路由逻辑高效，无性能影响
- [ ] 错误处理机制健全
- [ ] 日志输出规范统一

### 集成验证
- [ ] GitHub平台功能完全无影响
- [ ] 云效平台命令正常执行
- [ ] 配置文件变更后立即生效
- [ ] 多平台环境切换测试通过

### 文档交付
- [ ] 平台配置指南
- [ ] 命令路由机制说明
- [ ] 故障诊断和排查文档
- [ ] 配置示例和最佳实践

### 验收标准
- [ ] 用户可以通过简单配置在GitHub和云效平台间切换
- [ ] 所有PM命令在两个平台上表现一致
- [ ] 配置错误时提供清晰的诊断和修复建议
- [ ] 为任务007（配置文档）提供完整的功能基础
